# MultiFuelMaster - Система АСУ для управления 8 ТРК

## Общее описание
Система автоматизированного управления для одновременной работы с 8 топливораздаточными колонками (ТРК) через отдельные COM-порты. Обеспечивает "живое" отображение процесса отпуска топлива без лагов и тормозов UI.

## Техническая архитектура

### Основной стек технологий
- **UI Layer**: C# + WPF (MVVM)
- **I/O Layer**: Асинхронные workers для каждого ТРК
- **Коммуникация**: Протокол GasKitLink v1.2 (RS422, 9600 бод)

### Ключевые принципы
1. **Неблокирующий I/O** - UI никогда не ждет операций ввода-вывода
2. **Снапшотная архитектура** - UI обновляется из последних данных, а не в реальном времени
3. **Ограниченный параллелизм** - максимум 4 одновременных COM-операции
4. **Приоритетная обработка** - критические данные обрабатываются первыми

## Архитектурные компоненты

### 1. PortWorker (8 экземпляров)
Отдельный worker для каждой ТРК:
- Выделенный поток/Task с SerialPort
- Последовательная обработка команд (SR → LM → RS)
- Строгое соблюдение таймингов протокола
- Автономная работа без блокировок

### 2. State Manager
Центральный менеджер состояний:
- Хранит последние снапшоты данных от всех ТРК
- Обновляет UI по таймеру (20 Hz / 50 мс)
- Управляет приоритетной очередью команд
- Координирует логирование

### 3. UI Layer (WPF)
- MVVM архитектура
- Data binding к снапшотам
- Виртуализация списков
- Адаптивное обновление только измененных данных

## Протокольные особенности

### Режимы работы ТРК
- **Idle (1)**: Опрос SR каждые 500 мс
- **Transaction (3-8)**: Интенсивный цикл SR → LM → RS каждые 30-50 мс
- **Stop/End (8-9)**: Запрос финальных данных (T), тоталайзеры (C)

### Тайминги протокола
- Задержка ответа Slave: 3 мс
- Таймаут ожидания Master: 50 мс
- Межбайтовый таймаут: 3 мс
- Скорость: 9600 бод, RS422

## Оптимизации производительности

### 1. Частота опроса
- **Режим ожидания**: 2 опроса/сек на ТРК
- **Транзакция**: 20-33 опроса/сек на ТРК
- **Общая нагрузка**: до 264 обновлений/сек

### 2. UI оптимизации
- Throttling обновлений: максимум 10 обновлений/сек на ТРК
- Batch обработка изменений
- Delta-обновления (только измененные данные)
- Приоритетная очередь событий

### 3. I/O оптимизации
- SemaphoreSlim(4) для ограничения параллелизма
- ConfigureAwait(false) для async операций
- Pooling объектов для снижения GC давления
- Кэширование неизменных данных

## Структура проекта

```
MultiFuelMaster/
├── UI/                     # WPF слой (ViewModels, Views)
├── Core/                   # Бизнес-логика
│   ├── Models/            # Модели данных ТРК
│   ├── Services/          # Сервисы (State Manager)
│   └── Workers/           # PortWorker реализации
├── Protocol/               # Реализация протокола GasKitLink
├── Logging/                # Система логирования
└── Configuration/          # Настройки и конфигурация
```

## Критические требования

### Производительность
- UI отзывчивость: < 50 мс на действие пользователя
- Задержка отображения данных: < 100 мс
- Максимальная нагрузка: 8 ТРК × 33 опроса/сек

### Надежность
- Graceful degradation при потере связи
- Автоматическое восстановление после ошибок
- Защита от race conditions и deadlocks

### Совместимость
- Windows 10/11
- .NET 6.0+ (или выше)
- COM-порты RS422

## План разработки

1. **Базовая архитектура** - реализация PortWorker и State Manager
2. **Протокол** - реализация GasKitLink v1.2
3. **UI слой** - WPF интерфейс с MVVM
4. **Оптимизация** - тестирование производительности и доработка
5. **Тестирование** - интеграционные и нагрузочные тесты

## Контрольные точки

- [ ] Базовая связь с 1 ТРК без тормозов UI
- [ ] Одновременная работа 8 ТРК
- [ ] "Живое" отображение во время транзакций
- [ ] Корректная обработка ошибок связи
- [ ] Соответствие эталонному логу

## Полезные ссылки

- Протокол: `GasKitLinkv1.2.doc`
- Эталонный лог: `ЛОГ_эталонной_программы.txt`
- Технические требования: 9600 бод, RS422, Full duplex