# Qoder_AUDIT.md
## Аудит архитектуры и качества проекта MultiFuelMaster
**Цель:** полностью русскоязычный интерфейс, неблокирующий UI, фундамент под одновременную работу с 8 топливораздаточными постами.

---

## 1. Архитектура UI и потоков выполнения

### Проблема
В проекте присутствуют синхронные вызовы (`.Result`, `.Wait()`, блокирующие операции), которые потенциально выполняются в UI-потоке.

### Риск
- зависание интерфейса;
- потеря обновлений реальных данных;
- некорректная работа при одновременном обслуживании 8 постов;
- дедлоки при async-операциях.

### Требование
- Запрещено использовать `.Result`, `.Wait()`, `Task.WaitAll()` в UI и ViewModel.
- Все операции ввода-вывода (COM, БД, файлы) — **только `async/await`**.
- UI-поток занимается **только отображением**.

---

## 2. Работа с базой данных (EF Core)

### Проблема
Использование долгоживущего `DbContext` через сервисы с singleton-жизненным циклом.

### Риск
- `DbContext` не является thread-safe;
- конфликты при параллельных операциях;
- рост памяти из-за tracking;
- нестабильная работа при нескольких постах.

### Требование
- Использовать `IDbContextFactory<AppDbContext>`.
- Создавать `DbContext` **на каждую операцию**.
- Сервисы работы с БД регистрировать как `Transient`.
- Запрещено хранить `DbContext` в полях классов.

---

## 3. Фундамент под 8 топливораздаточных постов

### Проблема
Отсутствует чёткое разделение между:
- логикой поста,
- транспортом (COM/RS-485),
- UI.

### Риск
- UI будет блокироваться при опросе колонок;
- масштабирование на 8 постов приведёт к фризам;
- сложность отладки и расширения.

### Требование
- Каждый пост = независимый контроллер (логика поста).
- Каждый контроллер работает в собственной фоновой Task-петле.
- Управление жизненным циклом через `CancellationToken`.
- UI **не обращается напрямую** к COM-порту и протоколу.
- UI получает только *снимки состояния* (snapshot / DTO).

---

## 4. Обновление UI

### Проблема
Потенциальное прямое обновление UI при каждом событии данных.

### Риск
- перегрузка Dispatcher;
- визуальные лаги;
- пропуски кадров и рывки интерфейса.

### Требование
- Использовать коалесинг обновлений:
  - UI-таймер (100–200 мс) отображает последнее состояние;
- Обновление UI — только через Dispatcher.
- Частые данные (объём, сумма, статус) не должны вызывать прямые `Invoke` при каждом байте.

---

## 5. Логирование

### Проблема
Синхронная запись в файл и блокировки (`lock + File.AppendAllText`).

### Риск
- тормоза UI;
- потеря логов;
- невозможность анализа ошибок при нагрузке.

### Требование
- UI и логика **не пишут файл напрямую**.
- Использовать очередь логов.
- Один фоновый writer пишет лог в файл.
- Исключения при логировании не должны теряться.

---

## 6. Строки интерфейса и локализация

### Проблема
Строки интерфейса и сообщений разбросаны по ViewModel, сервисам и XAML.

### Риск
- невозможность централизованного контроля языка;
- сложность поддержки;
- риск появления нерусских сообщений.

### Требование
- Весь интерфейс — **строго на русском языке**.
- Сообщения об ошибках, статусах и диалогах централизовать.
- ViewModel не должны напрямую вызывать `MessageBox`.

---

## 7. Безопасность и данные пользователей

### Проблема
Используется простое хеширование паролей с фиксированной солью.

### Риск
- уязвимость к перебору;
- небезопасное хранение учётных данных.

### Требование
- Использовать PBKDF2 (`Rfc2898DeriveBytes`) или эквивалент.
- Индивидуальная соль для каждого пользователя.
- Никогда не хранить пароли в открытом виде.

---

## 8. Файлы данных в проекте

### Проблема
В проекте могут присутствовать реальные данные (SQLite `.db`).

### Риск
- утечка данных;
- конфликты при сборке;
- неконтролируемое состояние БД.

### Требование
- Файлы БД **не должны** находиться в репозитории.
- База создаётся/мигрируется автоматически при запуске.

---

## 9. Общее архитектурное правило

### Ключевой принцип
**UI ≠ логика ≠ протокол ≠ транспорт**

Нарушение этого принципа приведёт к:
- неустранимым лагам,
- нестабильной работе при 8 постах,
- невозможности безопасного развития проекта.

---

**Конец документа**
