# MultiFuelMaster - Текущее состояние проекта

## Дата обновления: 13.02.2026

---

## 1. Общее описание

**MultiFuelMaster** - система автоматизированного управления для АЗС (автозаправочных станций). WPF-приложение на .NET 8.0 с SQLite базой данных.

### Технологический стек
- **UI**: WPF + Material Design
- **База данных**: SQLite + Entity Framework Core
- **Архитектура**: MVVM (CommunityToolkit.Mvvm)
- **Шифрование**: AES-256 для sensitive данных

---

## 2. Реализованные функции

### ✅ Аутентификация
- [x] Окно создания первого администратора (SetupWindow)
- [x] Окно входа (LoginWindow)
- [x] Хэширование паролей (SHA256)
- [x] Роли пользователей (User, Admin, SuperAdmin)
- [x] Проверка прав при входе

### ✅ Интерфейс главного окна
- [x] Фиолетовая верхняя панель с названием приложения
- [x] Отображение логина текущего пользователя (справа в верхней панели)
- [x] Боковое меню "Параметры системы" (только для SuperAdmin)
- [x] Пустая панель управления по умолчанию
- [x] Статус-бар с информацией о подключении к БД

### ✅ Вертикальное меню "Параметры системы"
Список пунктов меню:
1. Параметры АЗС ✅
2. Пользователи - (ещё не реализовано)
3. Виды топлива ✅
4. Ёмкости ✅
5. Каналы ТРК - (ещё не реализовано)
6. Посты - (ещё не реализовано)
7. Параметры продаж - (ещё не реализовано)

### ✅ Параметры АЗС (реализовано 13.02.2026)
- [x] Поля: Название АЗС, Адрес АЗС, Название компании
- [x] Выбор языка (Русский, Узбекский, Английский)
- [x] Выбор валюты (UZS, USD, EUR, RUB)
- [x] Путь архивирования MultiFuelMaster
- [x] Кнопки "Сохранить" и "Отмена"
- [x] **Шифрование всех текстовых данных (AES)** перед сохранением в БД
- [x] Автоматическое закрытие формы после сохранения/отмены

### ✅ Виды топлива (реализовано 13.02.2026)
- [x] Просмотр списка всех видов топлива в таблице
- [x] Кнопка "Добавить топливо"
- [x] Кнопки редактирования и удаления для каждой записи
- [x] Форма добавления/редактирования с полями:
  - Номер (автоинкремент)
  - Краткое название (обязательно)
  - Полное название (обязательно)
  - Название на чеке
  - Единица измерения (литры, кг, м³)
  - Выбор цвета (Зеленый, Красный, Синий, Желтый, Другой)
  - Код ИКПУ (опционально)
  - Код упаковки (опционально)
  - Код страны происхождения (опционально)
  - ИНН клиента (опционально)
  - Активный (чекбокс)
- [x] Сохранение данных в SQLite базу
- [x] Удаление с подтверждением
- [x] Валидация обязательных полей

### ✅ Ёмкости (реализовано 13.02.2026)
- [x] Просмотр списка всех ёмкостей в таблице
- [x] Кнопка "Добавить ёмкость"
- [x] Кнопки редактирования и удаления для каждой записи
- [x] Форма добавления/редактирования с полями:
  - Номер ёмкости (обязательно, автоинкремент)
  - Тип топлива (выбор из выпадающего списка с цветными превью)
  - Максимальный объем (литры)
  - Минимальный объем (литры)
  - Критический остаток
  - Реакция на критический остаток (из выпадающего списка)
  - Текущий уровень (литры)
  - Статус (Активная/Неактивная/На обслуживании/Заблокирована)
  - Заблокирована на время прихода топлива (чекбокс)
  - Активная (чекбокс)
- [x] Общие параметры:
  - Разрешить блокировку ёмкости на время прихода топлива
  - Контроль остатков в ёмкостях
- [x] Сохранение данных в SQLite базу
- [x] Удаление с подтверждением
- [x] Валидация обязательных полей
- [x] Проверка уникальности номера ёмкости

### ✅ База данных
- [x] SQLite база данных (fuelmaster.db)
- [x] Таблицы: Users, FuelStations, FuelTypes, Dispensers, Transactions, StationSettings, Tanks
- [x] Read-only доступ для основных данных
- [x] Зашифрованное хранение настроек

---

## 3. Структура проекта

```
MultiFuelMaster/
├── Models/
│   ├── User.cs              # Модель пользователя
│   ├── StationSettings.cs   # Настройки станции (зашифровано)
│   ├── FuelStation.cs       # Станции
│   ├── FuelType.cs         # Виды топлива
│   ├── Tank.cs             # Ёмкости
│   ├── Dispenser.cs        # ТРК (топливораздаточные колонки)
│   └── Transaction.cs       # Транзакции
├── Services/
│   ├── AuthService.cs           # Аутентификация
│   ├── DatabaseService.cs       # Работа с БД (только чтение)
│   ├── EncryptionService.cs     # Шифрование AES
│   ├── StationSettingsService.cs # Настройки станции
│   ├── FuelTypeService.cs       # CRUD операции для видов топлива
│   └── TankService.cs           # CRUD операции для ёмкостей
├── ViewModels/
│   ├── MainViewModel.cs
│   ├── StationSettingsViewModel.cs
│   ├── FuelTypesViewModel.cs
│   ├── TanksViewModel.cs
│   └── ... (другие ViewModels)
├── Views/
│   ├── LoginWindow.xaml(.cs)
│   ├── SetupWindow.xaml(.cs)
│   ├── StationSettingsView.xaml(.cs)
│   ├── FuelTypesView.xaml(.cs)
│   ├── TanksView.xaml(.cs)
│   └── ... (другие Views)
├── Data/
│   └── AppDbContext.cs    # Контекст EF Core
├── Converters/
│   ├── InverseBooleanToVisibilityConverter.cs
│   ├── BoolToAddEditConverter.cs
│   ├── ColorRadioConverter.cs
│   ├── HexToColorBrushConverter.cs
│   └── EnumHelper.cs
├── App.xaml(.cs)          # Точка входа
└── MainWindow.xaml        # Главное окно
```

---

## 4. Как добавить новый пункт меню

### Шаг 1: Создать ViewModel
Создать файл в `ViewModels/`:
```csharp
public partial class NewFeatureViewModel : BaseViewModel
{
    private readonly SomeService _service;
    private readonly Action _onComplete;
    
    public NewFeatureViewModel(SomeService service, Action onComplete)
    {
        _service = service;
        _onComplete = onComplete;
    }
    
    [RelayCommand]
    private async Task SaveAsync()
    {
        // Логика сохранения
        await Task.Delay(1000);
        _onComplete?.Invoke();  // Закрыть форму
    }
}
```

### Шаг 2: Создать View
Создать файл в `Views/NewFeatureView.xaml` и `.xaml.cs`

### Шаг 3: Добавить команду в MainViewModel
```csharp
[RelayCommand]
private void NavigateToNewFeature()
{
    var viewModel = new NewFeatureViewModel(_someService, NavigateToEmptyDashboard);
    CurrentView = new NewFeatureView { DataContext = viewModel };
    WindowTitle = "MultiFuelMaster - Название";
}
```

### Шаг 4: Добавить кнопку в MainWindow.xaml
```xml
<Button Command="{Binding NavigateToNewFeatureCommand}">
    <StackPanel>
        <materialDesign:PackIcon Kind="Icon"/>
        <TextBlock Text="Название"/>
    </StackPanel>
</Button>
```

### Шаг 5: Зарегистрировать сервис в App.xaml.cs
```csharp
services.AddSingleton<SomeService>();
```

---

## 5. Важные замечания

1. **Шифрование**: Все sensitive данные хранятся зашифрованными через EncryptionService
2. **Права доступа**: Меню "Параметры системы" видимо только для SuperAdmin
3. **База данных**: При изменении модели удалить старую БД (fuelmaster.db)
4. **Material Design**: Используется версия 4.9.0

---

## 6. Следующие шаги (что нужно реализовать)

1. ~~Параметры АЗС~~ ✅
2. ~~Виды топлива~~ ✅
3. ~~Ёмкости~~ ✅
4. Пользователи - управление пользователями системы
5. Каналы ТРК - настройка COM-портов
6. Посты - настройка постов управления
7. Параметры продаж - настройки ценообразования

---

*Этот файл обновляется при реализации каждой новой функции*
